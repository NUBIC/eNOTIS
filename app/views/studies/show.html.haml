- @view_stylesheets = ["compiled/application", "facebox", "compiled/datatables", "compiled/accrual_graph", "compiled/main"]
- @view_javascripts = ["jquery-1.3.2.min", "jquery-ui-1.7.2.min" ,"jrails", "facebox", "jquery.dataTables.min", "jquery.main", "jquery.flot.pack", "excanvas.pack", "study-tabs"] # flot and excanvas are used for the accrual graph, study-tabs for the tabs

- content_for :head do
  %script{:type => 'text/javascript'}
    $(document).ready(function(){
    // show the Data Tables
    $(".display").dataTable();
    // show the accrual graph
    = "var e = #{@study_events.with_event_types([DictionaryTerm.find_by_term("Consented")]).to_graph.inspect};"
    $.plot($("#accrual-graph"), [e], { grid: {borderWidth: 0}, xaxis: { mode: "time" } });
    });
#study
  #vitals
    %span.irb_number= @study.irb_number
    %span.status= @study.status
  #details
    .description
      %span.title
        %span.label= "Title:"
        = @study.title
      %br
      %span.label= "Short Title:"
      %span.short_title= @study.name
      %hr
      %span.phase
        %span.label= "Phase:"
        = @study.phase || "Not Specififed"
      %span.research_type
        %span.label= "Research Type:"
        = @study.research_type
    .study_staff
      %span.pi
        %span.label= "Princpal Investigator:"
        = "#{@study.pi_last_name},#{@study.pi_first_name} (#{@study.pi_email})"
      %br
      %span.sc
        %span.label= "Study Coordinator:" 
        = "#{@study.sc_last_name},#{@study.sc_first_name} (#{@study.sc_email})"
  %br.clear
  - if @study.has_coordinator?(current_user)
    %ul.study_tabs
      %li.nav= study_tab_to "Overview", "#overview"
      %li.nav= study_tab_to "Study Subjects", "#subjects"
      %li.nav= study_tab_to "Events", "#events"
      %li.nav= study_tab_to "Subject Imports", "#imports"


    #overview
      #accrual
        .heading Accrual Graph
        #accrual-graph
      #staff_list
        .heading Staff list
        %ul
          - @study.coordinators.each do |c|        
            %li
              = "#{c.first_name} #{c.last_name}"
              %br
      #study-events
        .heading Recent Events
        %ul
        - @study_events.all(:limit => 5).each do |ie|
          %li
            -# ">" before = removes extra spacing around this tag
            %dtr{:title => ie.description}>= ie.term
            = ": #{ie.involvement.subject.name} #{time_ago_in_words(ie.occured_at)} ago"

    #subjects
      - if @study.subjects.empty?
        = render :partial => "subjects/no_subjects"
        = link_to("Add Subject", new_involvement_event_path(:study => @study), :rel => 'facebox')
      - else
        = "#{pluralize(@study.subjects.size, "subject")} associated with this study"
        = link_to("Add Subject", new_involvement_event_path(:study => @study), :rel => 'facebox')
        %table.display
          %thead
            %th Name
            %th 
            %th
          %tbody  
            - @study.subjects.each do |subject|
              %tr{:class => "subject_#{subject.id}"}
                %td= render :partial => 'partials/subject', :object => subject
                %td= subject.synced? ? "Subject Synced" : link_to("Sync", search_subjects_url(:id=>subject.id), :rel => 'facebox')
                %td= link_to("Add Event", new_involvement_event_path(:subject => subject, :study => @study), :rel => 'facebox')
    #events
      %h4 Events
      - if @study_events.empty?
        = render :partial => "involvement_events/no_events"
      - else
        %table.display
          %thead
            %th Name
            %th Event
            %th Note
            %th Date
          %tbody
            - @study_events.all.each do |event|
              %tr{:class => "subject_#{event.involvement.subject.id}"}
                %td= event.involvement.subject.name
                %td
                  %a{:title => event.description, :href => involvement_event_path(event)}= event.term
                %td= event.note
                %td= event.occured_at
    #imports
      %h4 Imports
      - form_tag('/subjects', :multipart => true) do
        = hidden_field_tag("study_id",@study.irb_number.to_s)
        %br
        = file_field_tag(:file)
        = submit_tag( "Upload" )
        %br
        %Hr
      %table.display
        %thead
          %th Importer
          %th Upload Date
          %th Original
          %th Result
          %th Status
        %tbody
          - @study.study_uploads.each do |u|
            %tr
              %td= u.user.netid
              %td= u.created_at
              %td= link_to "View", u.upload.url
              %td= (u.result_file_name.nil?) ? "Unavailable" : link_to( "View", u.result.url)
              %td= u.summary || "Still Processing"
