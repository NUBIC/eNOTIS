- @view_stylesheets = ["compiled/application", "facebox", "compiled/datatables", "compiled/accrual_graph"]
- @view_javascripts = ["jquery-1.3.2.min", "jquery-ui-1.7.2.min" ,"jrails", "facebox", "jquery.dataTables.min", "jquery.main", "jquery.flot.pack", "excanvas.pack"] # flot and excanvas are used for the accrual graph
- content_for :head do
  %script{:type => 'text/javascript'}
    $(document).ready(function(){
    $("#study").tabs(); $(".display").dataTable(); // instantiate jQueryUITabs
    // http://articles.rootsmith.ca/mod_python/how-to-make-jquery-ui-tabs-linkable-or-bookmarkable#comment-10188
    var anchor = $(document).attr('location').hash; // the anchor in the URL
    var index = $('#study div.ui-tabs-panel').index($(anchor)); // in tab index of the anchor in the URL
    $('#study').tabs('select', index); // select the tab
    $('#study').bind('tabsshow', function(event, ui){document.location = $(document).attr('location').pathname + "#" + ui.panel.id;}); // change the url anchor when we click on a tab
    = "var e = #{@study_events.with_event_types([DictionaryTerm.find_by_term("Consented")]).to_graph.inspect};"
    $.plot($("#accrual"), [e], { grid: {borderWidth: 0}, xaxis: { mode: "time" } });
    });
#study
  .vitals
    %p.irb_number= @study.irb_number
    %p.status= @study.status
  .details
    .description
      %p= "Title: #{@study.title}"
      %p= "Short Title: #{@study.name}"
      %p= "Phase: #{@study.phase}"
      %p= "Research Type: #{@study.research_type}"
    .study_staff
      %p= "Princpal Investigator: #{@study.pi_last_name},#{@study.pi_first_name} (#{@study.pi_email})"
      %p= "Study Coordinator: #{@study.sc_last_name},#{@study.sc_first_name} (#{@study.sc_email})"
  %br.clear
  - if @study.has_coordinator?(current_user)
    %ul.study_tabs
      %li.nav= study_tab_to "Overview", "#overview"
      %li.nav= study_tab_to "Study Subjects", "#subjects"
      %li.nav= study_tab_to "Events", "#events"
      %li.nav= study_tab_to "Subject Imports", "#imports"
    #overview
      .column
        #accrual
        #study-events
          .heading Recent Events
          %ul
            - @study_events.all(:limit => 5).each do |ie|
              %li
                -# ">" before = removes extra spacing around this tag
                %dtr{:title => ie.description}>= ie.term
                = ": #{ie.involvement.subject.name} #{time_ago_in_words(ie.occured_at)} ago"
      #staff_list.column
        .heading Staff list
        %ul
          - @study.coordinators.each do |c|        
            %li
              = "#{c.first_name} #{c.last_name}"
              %br

      %br.clear
    #subjects
      = (@study.involvements || []).size
      subjects currently associated with this study
      -if @study.has_coordinator?(@current_user)
        = link_to("Add Subject", new_involvement_event_path(:study => @study), :rel => 'facebox')
      %table.display
        %thead
          %th Name
          %th 
          %th
        %tbody  
          - @study.subjects.each do |subject|
            %tr
              %td= render :partial => 'partials/subject', :object => subject
              %td= subject.synced? ? "Subject Synced" : link_to("Sync", search_subjects_url(:id=>subject.id), :rel => 'facebox')
              %td= link_to("Add Event", new_involvement_event_path(:subject => subject, :study => @study), :rel => 'facebox', :id => "add_event_#{subject.id}")
    #events
      %h4 Events
      %table.display
        %thead
          %th Name
          %th Event
          %th Note
          %th Date
        %tbody
          - @study_events.each do |event|
            %tr
              %td= event.involvement.subject.name
              %td
                %dfn{:title => event.description}= event.term
              %td= event.note
              %td= event.occured_at
    #imports
      %h4 Imports
      - form_tag('/subjects', :multipart => true) do
        = hidden_field_tag("study_id",@study.irb_number.to_s)
        %br
        = file_field_tag(:file)
        = submit_tag( "Upload" )
        %br
        %Hr
      %table.display
        %thead
          %th Importer
          %th Upload Date
          %th Original
          %th Result
          %th Status
        %tbody
          - @study.study_uploads.each do |u|
            %tr
              %td= u.user.netid
              %td= u.created_at
              %td= link_to "View", u.upload.url
              %td= (u.result_file_name.nil?) ? "Unavailable" : link_to( "View", u.result.url)
              %td= u.summary || "Still Processing"
