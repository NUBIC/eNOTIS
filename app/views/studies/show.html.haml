#study
  %span.study_title
    = status_icon @study
    = @study.irb_number || "(no id)"
    = link_to image_tag('/images/icons/information.png'), "#", :rel => "#study_information", :class => 'study_information'
  #study_information.overlay
    .title
      %span.status
        = status_icon @study
        = "#{@study.status}"
      %br
      %span.study_title= @study.title
    .details
      %span.phase= "Phase #{@study.phase}" unless @study.phase.blank?
      %span.research_type= "Research Type: #{@study.research_type}" unless @study.phase.blank?
      %span.department= "Department: ..."
      %span.pi
        = "PI: #{@study.pi_first_name} #{@study.pi_last_name}"
        = link_to @study.pi_email, "mailto:#{@study.pi_email}"
      %span.sc
        = "Coord: #{@study.sc_first_name} #{@study.sc_last_name}" 
        = link_to @study.sc_email, "mailto:#{@study.sc_email}"
    .staff
      Staff list&nbsp;
      %span.quiet (as listed in eIRB)
      %ul
        - @study.coordinators.each do |c|        
          %li= "#{c.first_name} #{c.last_name}"

      -# Recent events
        %ul
          - @study_events.all(:limit => 5).each do |ie|
            %li
              -# ">" before = removes extra spacing around this tag
              %dtr{:title => ie.description}>= ie.term
              = ": #{ie.involvement.subject.name} #{time_ago_in_words(ie.occurred_on || Date.today)} ago"
    .export
      = link_to("Export subjects", new_report_path(:study => @study), :rel => '#overlay', :class => 'export-subjects') unless @study.subjects.empty?
  
  #accrual
    #subject_information.overlay
      .contentWrap
    #involvement_information.overlay
      .contentWrap
    - if @study.subjects.empty?
      %p 
        No subjects yet - watch the video on adding subjects or start adding some.
        %br
        = image_tag '/images/video.jpg'
    - else
      %table.display
        %thead
          %tr
            %th= "Subjects (#{@study.subjects.size})"
            - @events.each do |event|
              %th
                %dtr{:title => event.description}= event.term
        %tbody
          - @study.involvements.each do |involvement|
            %tr{:class => "subject_#{involvement.subject.id}"}
              %td
                = involvement.subject_name_or_case_number
                = link_to image_tag('/images/icons/status_offline.png'), "#", :rel => "#subject_information", :class => 'subject'
                .subject_information
                  = render :partial => 'partials/subject', :locals => {:subject => involvement.subject, :involvement => involvement}
              - @events.each do |event|
                - if x = @study_events.detect{|e| e.involvement == involvement && e.event_type == event}
                  %td
                    = link_to( "#{x.occurred_on} #{image_tag '/images/icons/note.png' unless x.note.blank?}", "#", :title => event.term.capitalize, :rel => "#involvement_information", :class => 'involvement')
                    .involvement_information
                      %p= x.term
                      %p= x.note
                      %p
                        = image_tag('/images/icons/delete.png')
                        = link_to "remove", involvement_event_path(x), :method => :delete
                - else
                  %td= link_to image_tag('/images/icons/add.png'), new_involvement_event_path(:subject => involvement.subject, :study => @study, :event_type_id => event.id), :rel => '#overlay', :class => 'add_involvement'

    = link_to("Add Subject", new_involvement_event_path(:study => @study), :rel => '#overlay', :class => 'add')
    = link_to("Import", "#", :rel => "#import", :class => 'import')
  #import.overlay
    .upload
      Import subjects
      - form_tag('/subjects', :multipart => true) do
        = hidden_field_tag("study_id",@study.irb_number.to_s)
        = file_field_tag(:file)
        = submit_tag( "Upload" )
      %br
      %p= "Uploads need a few essential columns (see the #{link_to 'example file', '/documents/sample.csv'}) for eNOTIS to read them."
    - unless @study.study_uploads.blank?
      .uploads
        %table.display
          %thead
            %tr
              %th Importer
              %th Upload Date
              %th Original
              %th Result
              %th Status
          %tbody
            - @study.study_uploads.each do |u|
              %tr
                %td= u.user.netid
                %td= u.created_at
                %td= link_to "View", u.upload.url
                %td= (u.result_file_name.nil?) ? "Unavailable" : link_to( "View", u.result.url)
                %td= u.summary || "Still Processing"
